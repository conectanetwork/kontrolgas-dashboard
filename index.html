<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontrolGas Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px;
        }

        .status-online {
            background: rgba(76, 175, 80, 0.8);
        }

        .status-offline {
            background: rgba(244, 67, 54, 0.8);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .weight-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .battery-meter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .battery-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .battery-info {
            flex-grow: 1;
        }

        .battery-percentage {
            font-size: 1.2em;
            font-weight: bold;
        }

        .battery-voltage {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .battery-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .battery-ok {
            background: rgba(76, 175, 80, 0.8);
        }

        .battery-low {
            background: rgba(255, 152, 0, 0.8);
        }

        .battery-critical {
            background: rgba(244, 67, 54, 0.8);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: bold;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
        }

        .no-data {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
            padding: 40px;
        }

        .last-update {
            text-align: center;
            opacity: 0.8;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .weight-display {
                font-size: 2em;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä KontrolGas Dashboard</h1>
            <div id="connectionStatus" class="status-indicator status-offline">
                üî¥ Sin datos
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Card de Peso Actual -->
            <div class="card">
                <h3>‚öñÔ∏è Peso Actual</h3>
                <div id="weightDisplay" class="weight-display">-- kg</div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Estado</div>
                        <div id="calibrationStatus" class="info-value">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Valor RAW</div>
                        <div id="rawValue" class="info-value">--</div>
                    </div>
                </div>
            </div>

            <!-- Card de Bater√≠a con Medidor de Voltaje -->
            <div class="card">
                <h3>üîã Estado de Bater√≠a</h3>
                <div class="battery-meter">
                    <div class="battery-icon" id="batteryIcon">üîã</div>
                    <div class="battery-info">
                        <div class="battery-percentage" id="batteryPercentage">--%</div>
                        <div class="battery-voltage" id="batteryVoltage">-- V</div>
                    </div>
                    <div class="battery-status battery-ok" id="batteryStatus">OK</div>
                </div>
                <div class="progress-bar">
                    <div id="batteryProgress" class="progress-fill" style="width: 0%; background: #4CAF50;"></div>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Autonom√≠a</div>
                        <div id="batteryHours" class="info-value">-- h</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Capacidad</div>
                        <div id="batteryCapacity" class="info-value">-- mAh</div>
                    </div>
                </div>
            </div>

            <!-- Card de Informaci√≥n del Dispositivo -->
            <div class="card">
                <h3>üì± Informaci√≥n del Dispositivo</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Device ID</div>
                        <div id="deviceId" class="info-value">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Firmware</div>
                        <div id="firmwareVersion" class="info-value">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">WiFi</div>
                        <div id="wifiStatus" class="info-value">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">√öltimo Env√≠o</div>
                        <div id="lastSendReason" class="info-value">--</div>
                    </div>
                </div>
            </div>

            <!-- Card de Estad√≠sticas -->
            <div class="card">
                <h3>üìà Estad√≠sticas de Env√≠o</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div id="dataSends" class="stat-number">--</div>
                        <div class="stat-label">Datos Enviados</div>
                    </div>
                    <div class="stat-item">
                        <div id="weightTriggers" class="stat-number">--</div>
                        <div class="stat-label">Por Peso</div>
                    </div>
                    <div class="stat-item">
                        <div id="batteryTriggers" class="stat-number">--</div>
                        <div class="stat-label">Por Bater√≠a</div>
                    </div>
                    <div class="stat-item">
                        <div id="skippedSends" class="stat-number">--</div>
                        <div class="stat-label">Omitidos</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Historial (placeholder) -->
        <div class="chart-container">
            <h3>üìä Historial de Datos</h3>
            <div class="no-data">
                Los datos hist√≥ricos se mostrar√°n aqu√≠ cuando est√©n disponibles
            </div>
        </div>

        <div class="last-update">
            √öltima actualizaci√≥n: <span id="lastUpdate">--</span>
        </div>
    </div>

    <script>
        let lastDataReceived = null;
        let connectionCheckInterval;

        // Funci√≥n para actualizar el dashboard con datos recibidos
        function updateDashboard(data) {
            console.log('Datos recibidos:', data);
            
            // Actualizar indicador de conexi√≥n
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'status-indicator status-online';
            statusElement.innerHTML = 'üü¢ Conectado';
            
            // Actualizar peso
            if (data.weight !== undefined) {
                document.getElementById('weightDisplay').textContent = parseFloat(data.weight).toFixed(2) + ' kg';
            }
            
            // Actualizar estado de calibraci√≥n
            if (data.calibrated !== undefined && data.tara_set !== undefined) {
                let status = 'Sin calibrar';
                if (data.calibrated && data.tara_set) {
                    status = 'Calibrado';
                } else if (data.tara_set) {
                    status = 'Solo tara';
                }
                document.getElementById('calibrationStatus').textContent = status;
            }
            
            // Actualizar valor RAW
            if (data.raw_value !== undefined) {
                document.getElementById('rawValue').textContent = data.raw_value;
            }
            
            // ACTUALIZAR MEDIDOR DE BATER√çA CON VOLTAJE
            if (data.battery_percentage !== undefined) {
                const percentage = data.battery_percentage;
                const voltage = data.battery_voltage || '--';
                const icon = data.battery_icon || 'üîã';
                const isLow = data.battery_is_low || false;
                const isCritical = data.battery_is_critical || false;
                
                // Actualizar elementos de bater√≠a
                document.getElementById('batteryIcon').textContent = icon;
                document.getElementById('batteryPercentage').textContent = percentage + '%';
                document.getElementById('batteryVoltage').textContent = voltage + ' V';
                document.getElementById('batteryHours').textContent = (data.battery_hours_remaining || '--') + ' h';
                document.getElementById('batteryCapacity').textContent = (data.battery_capacity_mah || '--') + ' mAh';
                
                // Actualizar barra de progreso
                const progressBar = document.getElementById('batteryProgress');
                progressBar.style.width = percentage + '%';
                
                // Actualizar colores seg√∫n estado
                let statusText = 'OK';
                let statusClass = 'battery-ok';
                let progressColor = '#4CAF50';
                
                if (isCritical) {
                    statusText = 'CR√çTICA';
                    statusClass = 'battery-critical';
                    progressColor = '#f44336';
                } else if (isLow) {
                    statusText = 'BAJA';
                    statusClass = 'battery-low';
                    progressColor = '#FF9800';
                }
                
                const statusElement = document.getElementById('batteryStatus');
                statusElement.textContent = statusText;
                statusElement.className = 'battery-status ' + statusClass;
                progressBar.style.background = progressColor;
            }
            
            // Actualizar informaci√≥n del dispositivo
            if (data.device_id) {
                document.getElementById('deviceId').textContent = data.device_id;
            }
            if (data.firmware_version) {
                document.getElementById('firmwareVersion').textContent = data.firmware_version;
            }
            if (data.wifi_ssid) {
                document.getElementById('wifiStatus').textContent = data.wifi_connected ? 
                    '‚úÖ ' + data.wifi_ssid : '‚ùå Desconectado';
            }
            if (data.send_reason) {
                document.getElementById('lastSendReason').textContent = data.send_reason;
            }
            
            // Actualizar estad√≠sticas
            if (data.data_sends !== undefined) {
                document.getElementById('dataSends').textContent = data.data_sends;
            }
            if (data.weight_triggers !== undefined) {
                document.getElementById('weightTriggers').textContent = data.weight_triggers;
            }
            if (data.battery_triggers !== undefined) {
                document.getElementById('batteryTriggers').textContent = data.battery_triggers;
            }
            if (data.skipped_sends !== undefined) {
                document.getElementById('skippedSends').textContent = data.skipped_sends;
            }
            
            // Actualizar timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            lastDataReceived = Date.now();
        }

        // Funci√≥n para manejar datos POST del ESP32
        function handleIncomingData(event) {
            if (event.data && typeof event.data === 'string') {
                try {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                } catch (e) {
                    console.error('Error parsing data:', e);
                }
            }
        }

        // Funci√≥n para verificar el estado de conexi√≥n
        function checkConnectionStatus() {
            const now = Date.now();
            const statusElement = document.getElementById('connectionStatus');
            
            if (!lastDataReceived || (now - lastDataReceived) > 120000) { // 2 minutos sin datos
                statusElement.className = 'status-indicator status-offline';
                statusElement.innerHTML = 'üî¥ Sin datos';
            }
        }

        // Simular recepci√≥n de datos para pruebas (remover en producci√≥n)
        function simulateData() {
            const testData = {
                device_id: 'KG_TEST123',
                firmware_version: 'v80.23-TEST',
                weight: (Math.random() * 10).toFixed(2),
                raw_value: Math.floor(Math.random() * 100000),
                calibrated: true,
                tara_set: true,
                battery_percentage: Math.floor(Math.random() * 100),
                battery_voltage: (3.0 + Math.random() * 1.2).toFixed(2),
                battery_icon: 'üü¢',
                battery_is_low: false,
                battery_is_critical: false,
                battery_hours_remaining: Math.floor(Math.random() * 24),
                battery_capacity_mah: 3000,
                wifi_connected: true,
                wifi_ssid: 'TestNetwork',
                send_reason: 'Prueba',
                data_sends: Math.floor(Math.random() * 100),
                weight_triggers: Math.floor(Math.random() * 50),
                battery_triggers: Math.floor(Math.random() * 20),
                skipped_sends: Math.floor(Math.random() * 30)
            };
            
            updateDashboard(testData);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar conexi√≥n cada 30 segundos
            connectionCheckInterval = setInterval(checkConnectionStatus, 30000);
            
            // Simular datos cada 10 segundos para pruebas (remover en producci√≥n)
            setInterval(simulateData, 10000);
            simulateData(); // Datos iniciales
            
            console.log('Dashboard inicializado');
        });

        // Escuchar eventos de datos del ESP32 (cuando est√© implementado)
        window.addEventListener('message', handleIncomingData);
        
        // Para recibir datos POST del ESP32
        if (window.location.protocol === 'https:') {
            // En producci√≥n, implementar endpoint para recibir datos POST
            console.log('Dashboard listo para recibir datos del ESP32');
        }
    </script>
</body>
</html>

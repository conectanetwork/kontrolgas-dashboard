<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontrolGas Dashboard</title>
    <!-- SDK de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #2d3748;
            font-weight: 300;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 50px;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .logo {
            font-size: 2rem;
            margin-bottom: 15px;
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo svg {
            width: 60px;
            height: 60px;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }

        .logo:hover svg {
            transform: scale(1.05);
        }

        .title {
            font-size: 2.5rem;
            font-weight: 200;
            margin-bottom: 10px;
            color: #2d3748;
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1rem;
            color: #718096;
            font-weight: 300;
        }

        .optimization-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
            font-weight: 400;
        }

        /* CONFIGURACI√ìN DIN√ÅMICA DEL DEVICE ID */
        .device-config {
            background: white;
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .device-config-label {
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .device-config-input {
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 400;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            transition: all 0.3s ease;
            background: #fafbfc;
            min-width: 250px;
            text-align: center;
        }

        .device-config-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .device-config-input:valid {
            border-color: #48bb78;
        }

        .device-config-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .device-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: background 0.3s ease;
        }

        .device-status-indicator.active {
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 400;
            color: #4a5568;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
        }

        /* GR√ÅFICO SEMICIRCULAR SVG AGRANDADO */
        .gauge-card {
            text-align: center;
            position: relative;
        }

        .gauge-container {
            position: relative;
            margin: 40px auto;
            width: 350px;
            height: 220px;
        }

        .gauge-svg {
            width: 350px;
            height: 200px;
            margin: 0 auto;
            display: block;
        }

        .gauge-track {
            stroke: #e2e8f0;
            stroke-width: 12;
            fill: none;
            stroke-linecap: round;
        }

        .gauge-fill {
            stroke: #48bb78;
            stroke-width: 12;
            fill: none;
            stroke-linecap: round;
            transition: stroke-dasharray 1.5s ease-in-out, stroke 0.5s ease;
        }

        .gauge-center {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .gauge-percentage {
            font-size: 3.5rem;
            font-weight: 100;
            color: #2d3748;
            margin-bottom: 8px;
            letter-spacing: -2px;
            transition: color 0.5s ease;
        }

        .gauge-label {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* VISOR DIGITAL CON FONDO PLOMO CLARO */
        .digital-card {
            text-align: center;
        }

        .digital-display {
            background: #9ca3af;
            color: white;
            border-radius: 16px;
            padding: 50px 30px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .digital-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .digital-value {
            font-size: 4rem;
            font-weight: 200;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            margin-bottom: 10px;
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
        }

        .digital-unit {
            font-size: 1.4rem;
            font-weight: 200;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* GR√ÅFICO DE CONSUMO CON EJES DIN√ÅMICOS */
        .chart-card {
            grid-column: 1 / -1;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin: 30px 0;
            background: #fafbfc;
            border-radius: 12px;
            padding: 20px;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        /* Ejes del gr√°fico */
        .chart-axes {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
        }

        .chart-y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 30px;
            width: 50px;
            border-right: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #718096;
        }

        .chart-x-axis {
            position: absolute;
            bottom: 0;
            left: 50px;
            right: 0;
            height: 30px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #718096;
        }

        .y-label {
            text-align: right;
            padding-right: 8px;
            line-height: 1;
            font-weight: 400;
        }

        .x-label {
            text-align: center;
            line-height: 1;
            font-weight: 400;
        }

        /* Cuadr√≠cula fina y detallada */
        .chart-grid {
            position: absolute;
            top: 0;
            left: 50px;
            right: 0;
            bottom: 30px;
        }

        .grid-line-h {
            position: absolute;
            left: 0;
            right: 0;
            height: 0.5px;
            background: #e8edf5;
        }

        .grid-line-v {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 0.5px;
            background: #e8edf5;
        }

        /* L√≠neas principales m√°s visibles */
        .grid-line-h.major {
            height: 1px;
            background: #d1d9e6;
        }

        .grid-line-v.major {
            width: 1px;
            background: #d1d9e6;
        }

        /* BARRA DE ESTADO MINIMALISTA */
        .status-bar {
            background: white;
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.06);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 300;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: #48bb78;
        }

        .status-disconnected {
            background: #f56565;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Medidor de Bater√≠a en la Barra de Estado */
        .battery-meter {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 300;
            font-size: 0.9rem;
            background: #fafbfc;
            padding: 12px 18px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .battery-icon {
            font-size: 1.2em;
        }

        .battery-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .battery-percentage {
            font-weight: 500;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .battery-voltage {
            font-size: 0.8rem;
            color: #718096;
        }

        .battery-progress {
            width: 60px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .battery-progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        /* PANEL DE CONFIGURACI√ìN */
        .config-panel {
            background: white;
            border-radius: 16px;
            padding: 35px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .config-title {
            font-size: 1.2rem;
            font-weight: 300;
            color: #2d3748;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .config-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-weight: 300;
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .input-field {
            padding: 15px 18px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 300;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* ESQUEMA DE COLORES ALTERNATIVO */
        .color-scheme-toggle {
            position: fixed;
            top: 25px;
            right: 25px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 300;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .color-scheme-toggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* ESQUEMA OSCURO */
        .dark-theme {
            background: #1a202c;
            color: #e2e8f0;
        }

        .dark-theme .card,
        .dark-theme .header,
        .dark-theme .status-bar,
        .dark-theme .config-panel,
        .dark-theme .device-config {
            background: #2d3748;
            border-color: #4a5568;
        }

        .dark-theme .title {
            color: #e2e8f0;
        }

        .dark-theme .gauge-track {
            stroke: #4a5568;
        }

        .dark-theme .gauge-percentage {
            color: #e2e8f0;
        }

        .dark-theme .digital-display {
            background: #4a5568;
        }

        .dark-theme .input-field,
        .dark-theme .device-config-input {
            background: #4a5568;
            border-color: #718096;
            color: #e2e8f0;
        }

        .dark-theme .chart-container {
            background: #4a5568;
        }

        .dark-theme .chart-y-axis,
        .dark-theme .chart-x-axis {
            border-color: #718096;
            color: #cbd5e1;
        }

        .dark-theme .grid-line-h,
        .dark-theme .grid-line-v {
            background: #4a5568;
        }

        .dark-theme .grid-line-h.major,
        .dark-theme .grid-line-v.major {
            background: #718096;
        }

        .dark-theme .battery-meter {
            background: #4a5568;
            border-color: #718096;
        }

        .dark-theme .battery-percentage {
            color: #e2e8f0;
        }

        .dark-theme .battery-progress {
            background: #718096;
        }

        /* INDICADOR DE CONEXI√ìN SUPABASE */
        .supabase-status {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.8rem;
            font-weight: 300;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .supabase-status.connected {
            border-color: #48bb78;
            color: #48bb78;
        }

        .supabase-status.error {
            border-color: #f56565;
            color: #f56565;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .config-inputs {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .device-config {
                flex-direction: column;
                text-align: center;
            }

            .device-config-input {
                min-width: 200px;
            }

            .btn-group {
                flex-direction: column;
            }

            .digital-value {
                font-size: 3rem;
            }

            .gauge-percentage {
                font-size: 2.8rem;
            }

            .gauge-container {
                width: 300px;
                height: 190px;
            }

            .gauge-svg {
                width: 300px;
                height: 170px;
            }

            .battery-meter {
                width: 100%;
                justify-content: center;
            }

            .chart-y-axis {
                width: 40px;
            }

            .chart-x-axis {
                left: 40px;
            }

            .chart-grid {
                left: 40px;
            }
        }
    </style>
</head>
<body>
    <button class="color-scheme-toggle" onclick="toggleTheme()">
        üåô Tema Oscuro
    </button>

    <!-- Indicador de estado de Supabase -->
    <div class="supabase-status" id="supabaseStatus">
        <span>üîÑ</span> Conectando a Supabase...
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea"/>
                            <stop offset="100%" style="stop-color:#764ba2"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="url(#logoGradient)" opacity="0.1"/>
                    <circle cx="50" cy="50" r="35" fill="none" stroke="url(#logoGradient)" stroke-width="3"/>
                    <circle cx="50" cy="50" r="25" fill="none" stroke="url(#logoGradient)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#logoGradient)" font-size="24" font-weight="bold">K</text>
                </svg>
            </div>
            <h1 class="title">KontrolGas</h1>
            <p class="subtitle">Monitoreo de Gas Profesional</p>
            <div class="optimization-badge">üöÄ Conectado a Supabase | Datos en Tiempo Real</div>
        </header>

        <!-- CONFIGURACI√ìN DIN√ÅMICA DEL DEVICE ID -->
        <div class="device-config">
            <label class="device-config-label" for="deviceIdInput">
                üì± ID del Dispositivo ESP32:
            </label>
            <input 
                type="text" 
                id="deviceIdInput" 
                class="device-config-input"
                placeholder="Ej: KG_392a13d8" 
                required
                pattern="[A-Za-z0-9_-]+"
                title="Solo letras, n√∫meros, guiones y guiones bajos"
            >
            <div class="device-config-status">
                <div class="device-status-indicator" id="deviceStatusIndicator"></div>
                <span id="deviceStatusText">Ingrese Device ID</span>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-connected" id="connectionIndicator"></div>
                <span id="connectionStatus">Conectando...</span>
            </div>
            <!-- Medidor de Voltaje de Bater√≠a -->
            <div class="battery-meter">
                <div class="battery-icon" id="batteryIcon">üîã</div>
                <div class="battery-info">
                    <div class="battery-percentage" id="batteryPercentage">--%</div>
                    <div class="battery-voltage" id="batteryVoltage">-- V</div>
                </div>
                <div class="battery-progress">
                    <div class="battery-progress-fill" id="batteryProgressFill" style="width: 0%; background: #48bb78;"></div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card gauge-card">
                <h3 class="card-title">
                    <span>üìä</span> Nivel de L√≠quido
                </h3>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <path class="gauge-track" d="M 30 90 A 70 70 0 0 1 170 90" stroke-linecap="round"/>
                        <path class="gauge-fill" d="M 30 90 A 70 70 0 0 1 170 90" stroke-dasharray="0 220" id="liquidGauge" stroke-linecap="round"/>
                    </svg>
                    <div class="gauge-center">
                        <div class="gauge-percentage" id="liquidLevel">0.0%</div>
                        <div class="gauge-label">Disponible</div>
                    </div>
                </div>
            </div>

            <div class="card digital-card">
                <h3 class="card-title">
                    <span>üî¢</span> Peso Digital
                </h3>
                <div class="digital-display">
                    <div class="digital-value" id="digitalWeight">0.00</div>
                    <div class="digital-unit">kg</div>
                </div>
            </div>

            <div class="card chart-card">
                <h3 class="card-title">
                    <span>üìà</span> Consumo √öltimas 24 Horas
                </h3>
                <div class="chart-container">
                    <canvas class="chart-canvas" id="consumptionChart"></canvas>
                    <!-- Ejes y cuadr√≠cula del gr√°fico din√°micos -->
                    <div class="chart-axes">
                        <!-- Eje Y (Peso neto din√°mico: 0 hasta peso_lleno - peso_vac√≠o) -->
                        <div class="chart-y-axis" id="yAxis">
                            <!-- Se genera din√°micamente -->
                        </div>
                        <!-- Eje X (24 horas) -->
                        <div class="chart-x-axis">
                            <div class="x-label">00:00</div>
                            <div class="x-label">04:00</div>
                            <div class="x-label">08:00</div>
                            <div class="x-label">12:00</div>
                            <div class="x-label">16:00</div>
                            <div class="x-label">20:00</div>
                            <div class="x-label">24:00</div>
                        </div>
                        <!-- Cuadr√≠cula fina -->
                        <div class="chart-grid" id="gridLines">
                            <!-- Se genera din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-panel">
            <h2 class="config-title">
                <span>‚öôÔ∏è</span> Configuraci√≥n de Pesos
            </h2>
            <div class="config-inputs">
                <div class="input-group">
                    <label class="input-label">Peso Vac√≠o (kg)</label>
                    <input type="number" class="input-field" id="emptyWeight" step="0.01" placeholder="5.00">
                </div>
                <div class="input-group">
                    <label class="input-label">Peso Lleno (kg)</label>
                    <input type="number" class="input-field" id="fullWeight" step="0.01" placeholder="13.00">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveConfiguration()">
                    <span>üíæ</span> Guardar Configuraci√≥n
                </button>
                <button class="btn btn-secondary" onclick="resetConfiguration()">
                    <span>üîÑ</span> Restablecer
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è CONFIGURACI√ìN DE SUPABASE - REEMPLAZAR CON TUS DATOS REALES
        const SUPABASE_URL = 'https://TU-PROYECTO.supabase.co';         // ‚ö†Ô∏è CAMBIAR POR TU URL
        const SUPABASE_ANON_KEY = 'TU-ANON-KEY-AQUI';                   // ‚ö†Ô∏è CAMBIAR POR TU ANON KEY

        // Variables globales
        let isDarkTheme = false;
        let lastDataReceived = null;
        let supabaseClient = null;
        let isSupabaseConnected = false;
        let ESP32_DEVICE_ID = ''; // Variable din√°mica para device_id

        // Inicializar cliente de Supabase
        function initSupabase() {
            try {
                if (SUPABASE_URL === 'https://TU-PROYECTO.supabase.co' || SUPABASE_ANON_KEY === 'TU-ANON-KEY-AQUI') {
                    updateSupabaseStatus('error', '‚ùå Configurar credenciales de Supabase');
                    console.error('‚ö†Ô∏è CONFIGURACI√ìN REQUERIDA: Actualiza SUPABASE_URL y SUPABASE_ANON_KEY en el c√≥digo');
                    return false;
                }

                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                updateSupabaseStatus('connected', '‚úÖ Conectado a Supabase');
                isSupabaseConnected = true;
                console.log('‚úÖ Cliente Supabase inicializado correctamente');
                return true;
            } catch (error) {
                updateSupabaseStatus('error', '‚ùå Error de conexi√≥n');
                console.error('‚ùå Error inicializando Supabase:', error);
                return false;
            }
        }

        // Actualizar indicador de estado de Supabase
        function updateSupabaseStatus(status, message) {
            const statusElement = document.getElementById('supabaseStatus');
            statusElement.className = `supabase-status ${status}`;
            statusElement.innerHTML = message;
        }

        // Actualizar estado del device ID
        function updateDeviceStatus(status, message) {
            const indicator = document.getElementById('deviceStatusIndicator');
            const text = document.getElementById('deviceStatusText');
            
            indicator.className = `device-status-indicator ${status}`;
            text.textContent = message;
        }

        // Configurar manejo din√°mico del device ID
        function setupDeviceIdInput() {
            const input = document.getElementById('deviceIdInput');
            const savedDeviceId = localStorage.getItem('esp32_device_id') || '';

            // Cargar valor guardado
            if (savedDeviceId) {
                input.value = savedDeviceId;
                ESP32_DEVICE_ID = savedDeviceId;
                updateDeviceStatus('active', `Conectado: ${savedDeviceId}`);
                
                // Si hay device_id guardado y Supabase est√° conectado, obtener datos
                if (isSupabaseConnected) {
                    updateDashboardWithRealData();
                }
            } else {
                updateDeviceStatus('', 'Ingrese Device ID');
            }

            // Escuchar cambios en el input
            input.addEventListener('input', function() {
                const newId = this.value.trim();
                
                if (newId.length === 0) {
                    ESP32_DEVICE_ID = '';
                    updateDeviceStatus('', 'Ingrese Device ID');
                    localStorage.removeItem('esp32_device_id');
                } else if (newId.length >= 3) {
                    ESP32_DEVICE_ID = newId;
                    localStorage.setItem('esp32_device_id', newId);
                    updateDeviceStatus('active', `Conectado: ${newId}`);
                    
                    // Actualizar datos inmediatamente
                    if (isSupabaseConnected) {
                        updateDashboardWithRealData();
                        console.log('üì± Device ID actualizado a:', newId);
                    }
                } else {
                    updateDeviceStatus('', 'M√≠nimo 3 caracteres');
                }
            });

            // Validaci√≥n en tiempo real
            input.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.which);
                if (!/[A-Za-z0-9_-]/.test(char)) {
                    e.preventDefault();
                }
            });
        }

        // Funci√≥n para obtener datos reales del ESP32 desde Supabase
        async function fetchRealESP32Data() {
            if (!isSupabaseConnected || !supabaseClient) {
                console.log('‚ö†Ô∏è Supabase no est√° conectado');
                return null;
            }

            if (!ESP32_DEVICE_ID || ESP32_DEVICE_ID.length === 0) {
                console.log('‚ö†Ô∏è No hay device_id configurado para consulta');
                updateDeviceStatus('', 'Ingrese Device ID');
                return null;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('esp32_data')
                    .select('*')
                    .eq('device_id', ESP32_DEVICE_ID)
                    .order('updated_at', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('‚ùå Error consultando Supabase:', error);
                    updateSupabaseStatus('error', '‚ùå Error consultando datos');
                    updateDeviceStatus('', `Error: ${ESP32_DEVICE_ID}`);
                    return null;
                }

                if (data && data.length > 0) {
                    console.log('‚úÖ Datos obtenidos de Supabase:', data[0]);
                    updateSupabaseStatus('connected', '‚úÖ Datos actualizados');
                    updateDeviceStatus('active', `Activo: ${ESP32_DEVICE_ID}`);
                    return data[0];
                } else {
                    console.log('‚ö†Ô∏è No se encontraron datos para device_id:', ESP32_DEVICE_ID);
                    updateSupabaseStatus('error', '‚ö†Ô∏è Sin datos del ESP32');
                    updateDeviceStatus('', `Sin datos: ${ESP32_DEVICE_ID}`);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error inesperado consultando Supabase:', error);
                updateSupabaseStatus('error', '‚ùå Error de conexi√≥n');
                updateDeviceStatus('', `Error: ${ESP32_DEVICE_ID}`);
                return null;
            }
        }

        // Funci√≥n para alternar tema
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('dark-theme', isDarkTheme);
            const toggle = document.querySelector('.color-scheme-toggle');
            toggle.textContent = isDarkTheme ? '‚òÄÔ∏è Tema Claro' : 'üåô Tema Oscuro';
        }

        // Funci√≥n CORREGIDA para actualizar escala Y seg√∫n peso neto m√°ximo (peso_lleno - peso_vac√≠o)
        function updateYAxisAndGrid() {
            const emptyWeight = parseFloat(document.getElementById('emptyWeight').value) || 5;
            const fullWeight = parseFloat(document.getElementById('fullWeight').value) || 13;
            
            // C√ÅLCULO CORRECTO: Peso neto m√°ximo = peso lleno - peso vac√≠o
            const pesoNetoMaximo = Math.max(fullWeight - emptyWeight, 1); // M√≠nimo 1kg para evitar errores
            
            const yAxis = document.getElementById('yAxis');
            const gridLines = document.getElementById('gridLines');
            
            if (!yAxis || !gridLines) return;

            // Limpiar contenido previo
            yAxis.innerHTML = '';
            gridLines.innerHTML = '';

            // N√∫mero de divisiones principales para el eje Y
            const divisionesPrincipales = 8;
            // Subdivisiones entre cada l√≠nea principal (l√≠neas finas)
            const subdivisionesPorDivision = 2;
            const totalLineasH = divisionesPrincipales * subdivisionesPorDivision;

            // Crear etiquetas del eje Y (de pesoNetoMaximo hacia 0)
            for (let i = divisionesPrincipales; i >= 0; i--) {
                const valor = (pesoNetoMaximo * i / divisionesPrincipales);
                const label = document.createElement('div');
                label.classList.add('y-label');
                label.textContent = valor.toFixed(1) + ' kg';
                yAxis.appendChild(label);
            }

            // Crear l√≠neas horizontales (cuadr√≠cula)
            for (let i = 0; i <= totalLineasH; i++) {
                const lineaH = document.createElement('div');
                lineaH.classList.add('grid-line-h');
                // L√≠neas principales cada subdivisionesPorDivision
                if (i % subdivisionesPorDivision === 0) {
                    lineaH.classList.add('major');
                }
                lineaH.style.top = (i * 100 / totalLineasH) + '%';
                gridLines.appendChild(lineaH);
            }

            // L√≠neas verticales para horas (cada 4 horas = 6 intervalos + l√≠neas intermedias cada hora)
            const horasPrincipales = 6; // 0, 4, 8, 12, 16, 20, 24
            const subdivisionesHoras = 4; // Una l√≠nea cada hora
            const totalLineasV = horasPrincipales * subdivisionesHoras;

            for (let i = 0; i <= totalLineasV; i++) {
                const lineaV = document.createElement('div');
                lineaV.classList.add('grid-line-v');
                // L√≠neas principales cada 4 horas
                if (i % subdivisionesHoras === 0) {
                    lineaV.classList.add('major');
                }
                lineaV.style.left = (i * 100 / totalLineasV) + '%';
                gridLines.appendChild(lineaV);
            }

            console.log(`Eje Y actualizado: 0 - ${pesoNetoMaximo.toFixed(1)} kg (Peso Lleno: ${fullWeight}kg - Peso Vac√≠o: ${emptyWeight}kg)`);
        }

        // Actualizar medidor de bater√≠a
        function updateBatteryMeter(data) {
            if (data.battery_percentage !== undefined) {
                const percentage = data.battery_percentage;
                const voltage = data.battery_voltage || '--';
                const icon = data.battery_icon || 'üîã';
                const isLow = data.battery_is_low || false;
                const isCritical = data.battery_is_critical || false;

                // Actualizar elementos
                document.getElementById('batteryIcon').textContent = icon;
                document.getElementById('batteryPercentage').textContent = percentage + '%';
                document.getElementById('batteryVoltage').textContent = voltage + ' V';

                // Actualizar barra de progreso
                const progressFill = document.getElementById('batteryProgressFill');
                progressFill.style.width = percentage + '%';

                // Actualizar color seg√∫n estado
                let progressColor = '#48bb78'; // Verde por defecto
                if (isCritical) {
                    progressColor = '#f56565'; // Rojo cr√≠tico
                } else if (isLow) {
                    progressColor = '#f6ad55'; // Naranja bajo
                }
                progressFill.style.background = progressColor;
            }
        }

        function updateGauge(percentage) {
            const gauge = document.getElementById('liquidGauge');
            const circumference = 220;
            const offset = circumference - (percentage / 100) * circumference;
            gauge.style.strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;

            // Cambiar color seg√∫n el nivel
            if (percentage < 20) {
                gauge.style.stroke = '#f56565';
            } else if (percentage < 50) {
                gauge.style.stroke = '#f6ad55';
            } else {
                gauge.style.stroke = '#48bb78';
            }
        }

        function updateDashboard(data) {
            console.log('üìä Actualizando dashboard con datos reales:', data);

            // Actualizar estado de conexi√≥n
            const statusElement = document.getElementById('connectionStatus');
            const indicator = document.getElementById('connectionIndicator');
            statusElement.textContent = `Conectado - ${ESP32_DEVICE_ID}`;
            indicator.className = 'status-indicator status-connected';

            // Actualizar peso digital
            if (data.weight !== undefined) {
                const weight = parseFloat(data.weight);
                document.getElementById('digitalWeight').textContent = weight.toFixed(2);

                // Calcular nivel de l√≠quido basado en configuraci√≥n
                const emptyWeight = parseFloat(document.getElementById('emptyWeight').value) || 5;
                const fullWeight = parseFloat(document.getElementById('fullWeight').value) || 13;

                if (fullWeight > emptyWeight) {
                    const percentage = Math.max(0, Math.min(100, 
                        ((weight - emptyWeight) / (fullWeight - emptyWeight)) * 100
                    ));
                    document.getElementById('liquidLevel').textContent = percentage.toFixed(1) + '%';
                    updateGauge(percentage);
                }
            }

            // Actualizar medidor de bater√≠a
            updateBatteryMeter(data);

            lastDataReceived = Date.now();
        }

        function checkConnectionStatus() {
            const now = Date.now();
            const statusElement = document.getElementById('connectionStatus');
            const indicator = document.getElementById('connectionIndicator');

            if (!lastDataReceived || (now - lastDataReceived) > 120000) {
                statusElement.textContent = 'Desconectado';
                indicator.className = 'status-indicator status-disconnected';
            }
        }

        function saveConfiguration() {
            const emptyWeight = document.getElementById('emptyWeight').value;
            const fullWeight = document.getElementById('fullWeight').value;

            if (emptyWeight && fullWeight) {
                const emptyVal = parseFloat(emptyWeight);
                const fullVal = parseFloat(fullWeight);

                if (fullVal <= emptyVal) {
                    alert('El peso lleno debe ser mayor que el peso vac√≠o');
                    return;
                }

                localStorage.setItem('emptyWeight', emptyWeight);
                localStorage.setItem('fullWeight', fullWeight);

                // Actualizar el gr√°fico con los nuevos valores
                updateYAxisAndGrid();

                const pesoNeto = fullVal - emptyVal;
                alert(`Configuraci√≥n guardada correctamente\nPeso neto m√°ximo: ${pesoNeto.toFixed(1)} kg`);
            } else {
                alert('Por favor, complete todos los campos');
            }
        }

        function resetConfiguration() {
            document.getElementById('emptyWeight').value = '';
            document.getElementById('fullWeight').value = '';
            localStorage.removeItem('emptyWeight');
            localStorage.removeItem('fullWeight');

            // Actualizar el gr√°fico con valores por defecto
            updateYAxisAndGrid();
            alert('Configuraci√≥n restablecida');
        }

        function loadConfiguration() {
            const emptyWeight = localStorage.getItem('emptyWeight');
            const fullWeight = localStorage.getItem('fullWeight');

            if (emptyWeight) document.getElementById('emptyWeight').value = emptyWeight;
            if (fullWeight) document.getElementById('fullWeight').value = fullWeight;

            // Actualizar el gr√°fico con los valores cargados
            updateYAxisAndGrid();
        }

        // Funci√≥n principal para actualizar dashboard con datos reales de Supabase
        async function updateDashboardWithRealData() {
            const data = await fetchRealESP32Data();
            if (data) {
                updateDashboard(data);
            } else {
                console.log('‚ö†Ô∏è No se pudieron obtener datos reales del ESP32');
            }
        }

        // Configurar suscripci√≥n en tiempo real a cambios en Supabase
        function setupRealtimeSubscription() {
            if (!isSupabaseConnected || !supabaseClient) {
                console.log('‚ö†Ô∏è No se puede configurar suscripci√≥n en tiempo real - Supabase no conectado');
                return;
            }

            try {
                const subscription = supabaseClient
                    .channel('esp32_data_changes')
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'esp32_data'
                        }, 
                        (payload) => {
                            console.log('üîÑ Cambio detectado en Supabase:', payload);
                            
                            // Solo procesar si es del device_id actual
                            if (payload.new && payload.new.device_id === ESP32_DEVICE_ID) {
                                updateDashboard(payload.new);
                            } else if (payload.old && payload.old.device_id === ESP32_DEVICE_ID) {
                                // Si se elimin√≥ un registro del device actual, actualizar
                                updateDashboardWithRealData();
                            }
                        }
                    )
                    .subscribe((status) => {
                        console.log('üì° Estado de suscripci√≥n en tiempo real:', status);
                    });

                console.log('‚úÖ Suscripci√≥n en tiempo real configurada');
            } catch (error) {
                console.error('‚ùå Error configurando suscripci√≥n en tiempo real:', error);
            }
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando KontrolGas Dashboard con Supabase...');

            // Inicializar Supabase
            const supabaseInitialized = initSupabase();

            // Configurar manejo din√°mico del device ID
            setupDeviceIdInput();

            // Cargar configuraci√≥n guardada
            loadConfiguration();

            // Configurar verificaci√≥n de estado de conexi√≥n
            setInterval(checkConnectionStatus, 30000);

            // Event listeners para actualizar gr√°fico
            document.getElementById('emptyWeight').addEventListener('input', updateYAxisAndGrid);
            document.getElementById('fullWeight').addEventListener('input', updateYAxisAndGrid);

            if (supabaseInitialized) {
                // Configurar actualizaci√≥n peri√≥dica cada 10 segundos
                setInterval(() => {
                    if (ESP32_DEVICE_ID && ESP32_DEVICE_ID.length > 0) {
                        updateDashboardWithRealData();
                    }
                }, 10000);

                // Configurar suscripci√≥n en tiempo real
                setupRealtimeSubscription();

                console.log('‚úÖ Dashboard inicializado con conexi√≥n a Supabase');
            } else {
                console.log('‚ùå Dashboard inicializado SIN conexi√≥n a Supabase');
                updateSupabaseStatus('error', '‚ùå Configurar credenciales');
            }
        });

        // Escuchar datos del ESP32 (mantener compatibilidad)
        window.addEventListener('message', function(event) {
            if (event.data && typeof event.data === 'string') {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì® Datos recibidos por PostMessage:', data);
                    updateDashboard(data);
                } catch (e) {
                    console.error('‚ùå Error parsing PostMessage data:', e);
                }
            }
        });

        console.log('üìä KontrolGas Dashboard con Supabase cargado');
    </script>
</body>
</html>

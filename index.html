<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontrolGas - Monitoreo Profesional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            transition: all 0.3s ease;
        }

        .dark-theme {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
        }

        .logo svg {
            width: 100%;
            height: 100%;
        }

        .subtitle {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .efficiency-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dark-theme .status-bar {
            background: rgba(45, 55, 72, 0.9);
            color: #e2e8f0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #fbbf24;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #4ade80;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark-theme .card {
            background: rgba(45, 55, 72, 0.95);
            color: #e2e8f0;
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.2em;
            text-align: center;
        }

        .dark-theme .card h3 {
            color: #e2e8f0;
        }

        .gauge-container {
            position: relative;
            width: 200px;
            height: 120px;
            margin: 0 auto;
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
        }

        .gauge-bg {
            fill: none;
            stroke: #e2e8f0;
            stroke-width: 12;
        }

        .gauge-fill {
            fill: none;
            stroke: url(#liquidGradient);
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .gauge-text {
            text-anchor: middle;
            font-size: 24px;
            font-weight: bold;
            fill: #2d3748;
        }

        .dark-theme .gauge-text {
            fill: #e2e8f0;
        }

        .gauge-label {
            text-anchor: middle;
            font-size: 12px;
            fill: #718096;
        }

        .dark-theme .gauge-label {
            fill: #a0aec0;
        }

        .gauge-status {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #4ade80;
        }

        .digital-display {
            background: linear-gradient(145deg, #1a202c, #2d3748);
            color: #00ff41;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            margin-top: 20px;
            border: 2px solid #4a5568;
        }

        .digital-value {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff41;
        }

        .digital-unit {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .chart-container {
            height: 200px;
            position: relative;
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .dark-theme .chart-container {
            background: #2d3748;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .chart-grid-line {
            stroke: #e2e8f0;
            stroke-width: 0.5;
        }

        .chart-grid-line.major {
            stroke-width: 1;
            stroke: #cbd5e0;
        }

        .chart-axis-text {
            font-size: 10px;
            fill: #718096;
        }

        .chart-line {
            fill: none;
            stroke: #667eea;
            stroke-width: 2;
        }

        .config-section {
            margin-top: 20px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-group label {
            font-size: 0.9em;
            color: #4a5568;
            font-weight: 500;
        }

        .dark-theme .config-group label {
            color: #e2e8f0;
        }

        .config-group input {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }

        .dark-theme .config-group input {
            background: #4a5568;
            border-color: #718096;
            color: #e2e8f0;
        }

        .config-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.5em;
            backdrop-filter: blur(10px);
            color: white;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .config-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="none" stroke="white" stroke-width="3"/>
                <path d="M30 50 L45 35 L55 45 L70 30" stroke="white" stroke-width="3" fill="none"/>
                <circle cx="50" cy="65" r="8" fill="white"/>
                <text x="50" y="85" text-anchor="middle" fill="white" font-size="8">K</text>
            </svg>
            <h1>KontrolGas</h1>
            <p class="subtitle">Monitoreo de Gas Profesional</p>
            <div class="efficiency-badge">üöÄ Nivel 2: Env√≠o Condicional | 97% Ahorro</div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionIndicator"></div>
                <span id="connectionStatus">Conectando...</span>
            </div>
            <div class="status-item">
                <span>Cliente ESP32: <span id="clientESP32">-</span></span>
            </div>
            <div class="status-item">
                <span>√öltima Actualizaci√≥n: <span id="lastUpdate">-</span></span>
            </div>
            <div class="status-item">
                <span>RSSI WiFi: <span id="wifiRSSI">-</span> dBm</span>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä Nivel de L√≠quido</h3>
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <defs>
                            <linearGradient id="liquidGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#ef4444"/>
                                <stop offset="50%" style="stop-color:#fbbf24"/>
                                <stop offset="100%" style="stop-color:#4ade80"/>
                            </linearGradient>
                        </defs>
                        <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100"/>
                        <path class="gauge-fill" id="liquidGauge" d="M 20 100 A 80 80 0 0 1 180 100" stroke-dasharray="0 251.2"/>
                        <text class="gauge-text" x="100" y="85" id="liquidPercentage">0.0%</text>
                        <text class="gauge-label" x="100" y="105">Disponible</text>
                    </svg>
                </div>
                <div class="gauge-status" id="liquidStatus">Disponible</div>
            </div>

            <div class="card">
                <h3>üî¢ Peso Digital</h3>
                <div class="digital-display">
                    <div class="digital-value" id="digitalWeight">0.00</div>
                    <div class="digital-unit">kg</div>
                </div>
            </div>

            <div class="card">
                <h3>üìà Consumo √öltimas 24 Horas</h3>
                <div class="chart-container">
                    <svg class="chart-svg" id="consumptionChart" viewBox="0 0 800 160">
                        <!-- Grid lines will be generated by JavaScript -->
                    </svg>
                </div>
            </div>
        </div>

        <div class="card config-section">
            <h3>‚öôÔ∏è Configuraci√≥n de Pesos</h3>
            <div class="config-grid">
                <div class="config-group">
                    <label for="emptyWeight">Peso Vac√≠o (kg)</label>
                    <input type="number" id="emptyWeight" value="15" step="0.1" min="0">
                </div>
                <div class="config-group">
                    <label for="fullWeight">Peso Lleno (kg)</label>
                    <input type="number" id="fullWeight" value="50" step="0.1" min="0">
                </div>
            </div>
            <div class="config-buttons">
                <button class="btn btn-primary" onclick="saveConfiguration()">üíæ Guardar Configuraci√≥n</button>
                <button class="btn btn-secondary" onclick="resetConfiguration()">üîÑ Restablecer</button>
            </div>
        </div>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

    <script>
        // Variables globales para el dashboard
        let currentWeight = 0;
        let currentLiquidPercentage = 0;
        let emptyWeight = 15;
        let fullWeight = 50;
        let weightHistory = [];
        let lastDataReceived = null;
        let connectionStatus = false;

        // Configuraci√≥n del gr√°fico
        const chartConfig = {
            width: 800,
            height: 160,
            marginLeft: 50,
            marginRight: 30,
            marginTop: 15,
            marginBottom: 30
        };

        // Funci√≥n para calcular el porcentaje de l√≠quido
        function calculateLiquidPercentage(weight) {
            if (weight <= emptyWeight) return 0;
            if (weight >= fullWeight) return 100;
            
            const netWeight = weight - emptyWeight;
            const maxNetWeight = fullWeight - emptyWeight;
            return (netWeight / maxNetWeight) * 100;
        }

        // Actualizar gauge semicircular
        function updateGauge(elementId, percentage) {
            const gauge = document.getElementById(elementId);
            if (!gauge) return;
            
            const normalizedPercentage = Math.min(Math.max(percentage, 0), 100) / 100;
            const circumference = 251.2; // Aproximadamente œÄ * 80 (radio del arco)
            const offset = circumference * normalizedPercentage;
            
            gauge.style.strokeDasharray = `${offset} ${circumference}`;
        }

        // Generar grid del gr√°fico
        function generateChartGrid() {
            const svg = document.getElementById('consumptionChart');
            svg.innerHTML = '';
            
            const plotWidth = chartConfig.width - chartConfig.marginLeft - chartConfig.marginRight;
            const plotHeight = chartConfig.height - chartConfig.marginTop - chartConfig.marginBottom;
            
            // Grid vertical (horas)
            for (let hour = 0; hour <= 24; hour += 4) {
                const x = chartConfig.marginLeft + (hour / 24) * plotWidth;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', chartConfig.marginTop);
                line.setAttribute('x2', x);
                line.setAttribute('y2', chartConfig.marginTop + plotHeight);
                line.setAttribute('class', 'chart-grid-line major');
                svg.appendChild(line);
                
                // Etiquetas de horas
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', chartConfig.marginTop + plotHeight + 15);
                text.setAttribute('class', 'chart-axis-text');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = hour.toString().padStart(2, '0') + ':00';
                svg.appendChild(text);
            }
            
            // Grid horizontal (porcentaje)
            for (let i = 0; i <= 5; i++) {
                const percentage = (i / 5) * 100;
                const y = chartConfig.marginTop + plotHeight - (i / 5) * plotHeight;
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', chartConfig.marginLeft);
                line.setAttribute('y1', y);
                line.setAttribute('x2', chartConfig.marginLeft + plotWidth);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'chart-grid-line major');
                svg.appendChild(line);
                
                // Etiquetas de porcentaje
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', chartConfig.marginLeft - 10);
                text.setAttribute('y', y + 4);
                text.setAttribute('class', 'chart-axis-text');
                text.setAttribute('text-anchor', 'end');
                text.textContent = percentage.toFixed(0) + '%';
                svg.appendChild(text);
            }
            
            // L√≠nea de datos (placeholder)
            const dataLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            dataLine.setAttribute('class', 'chart-line');
            dataLine.setAttribute('id', 'dataLine');
            dataLine.setAttribute('d', 'M ' + chartConfig.marginLeft + ' ' + (chartConfig.marginTop + plotHeight/2));
            svg.appendChild(dataLine);
        }

        // Funci√≥n principal para actualizar el dashboard
        function updateDashboard(data) {
            console.log('Actualizando dashboard con datos:', data);
            
            // Actualizar peso
            const weight = parseFloat(data.weight) || 0;
            currentWeight = weight;
            
            // Calcular porcentaje de l√≠quido
            const liquidPercentage = calculateLiquidPercentage(weight);
            currentLiquidPercentage = liquidPercentage;
            
            // Actualizar gauge de l√≠quido
            updateGauge('liquidGauge', liquidPercentage);
            document.getElementById('liquidPercentage').textContent = liquidPercentage.toFixed(1) + '%';
            
            // Actualizar estado del l√≠quido
            let status = 'Disponible';
            let statusColor = '#4ade80';
            if (liquidPercentage <= 10) {
                status = 'Cr√≠tico';
                statusColor = '#ef4444';
            } else if (liquidPercentage <= 25) {
                status = 'Bajo';
                statusColor = '#fbbf24';
            }
            
            const statusElement = document.getElementById('liquidStatus');
            statusElement.textContent = status;
            statusElement.style.color = statusColor;
            
            // Actualizar peso digital
            document.getElementById('digitalWeight').textContent = weight.toFixed(2);
            
            // Actualizar informaci√≥n de estado
            document.getElementById('clientESP32').textContent = data.device_id || 'ESP32-KG';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('wifiRSSI').textContent = data.wifi_rssi || '-';
            
            // Actualizar estado de conexi√≥n
            connectionStatus = true;
            const indicator = document.getElementById('connectionIndicator');
            const status_text = document.getElementById('connectionStatus');
            indicator.classList.add('connected');
            status_text.textContent = 'Conectado';
            
            // Agregar datos al historial para el gr√°fico
            addToWeightHistory(liquidPercentage);
            
            lastDataReceived = new Date();
        }

        // Agregar datos al historial
        function addToWeightHistory(percentage) {
            const now = new Date();
            const timeKey = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
            
            // Mantener solo las √∫ltimas 24 horas de datos
            if (weightHistory.length > 144) { // 24 horas * 6 puntos por hora
                weightHistory.shift();
            }
            
            weightHistory.push({
                time: timeKey,
                percentage: percentage,
                timestamp: now.getTime()
            });
            
            console.log('Historial actualizado:', weightHistory.length, 'puntos');
        }

        // Guardar configuraci√≥n
        function saveConfiguration() {
            emptyWeight = parseFloat(document.getElementById('emptyWeight').value) || 15;
            fullWeight = parseFloat(document.getElementById('fullWeight').value) || 50;
            
            // Guardar en localStorage
            localStorage.setItem('kontrolgas_empty_weight', emptyWeight);
            localStorage.setItem('kontrolgas_full_weight', fullWeight);
            
            // Recalcular porcentaje actual
            if (currentWeight > 0) {
                const newPercentage = calculateLiquidPercentage(currentWeight);
                updateGauge('liquidGauge', newPercentage);
                document.getElementById('liquidPercentage').textContent = newPercentage.toFixed(1) + '%';
            }
            
            alert('‚úÖ Configuraci√≥n guardada correctamente');
        }

        // Restablecer configuraci√≥n
        function resetConfiguration() {
            document.getElementById('emptyWeight').value = 15;
            document.getElementById('fullWeight').value = 50;
            emptyWeight = 15;
            fullWeight = 50;
            
            localStorage.removeItem('kontrolgas_empty_weight');
            localStorage.removeItem('kontrolgas_full_weight');
            
            alert('üîÑ Configuraci√≥n restablecida');
        }

        // Cargar configuraci√≥n guardada
        function loadConfiguration() {
            const savedEmpty = localStorage.getItem('kontrolgas_empty_weight');
            const savedFull = localStorage.getItem('kontrolgas_full_weight');
            
            if (savedEmpty) {
                emptyWeight = parseFloat(savedEmpty);
                document.getElementById('emptyWeight').value = emptyWeight;
            }
            
            if (savedFull) {
                fullWeight = parseFloat(savedFull);
                document.getElementById('fullWeight').value = fullWeight;
            }
        }

        // Simular datos para pruebas
        function simulateData() {
            const simulatedData = {
                device_id: 'ESP32-KG-DEMO',
                weight: (Math.random() * 30 + 15).toFixed(2), // Entre 15 y 45 kg
                wifi_rssi: Math.floor(Math.random() * 40 + 40) * -1, // Entre -40 y -80 dBm
                battery_percentage: Math.floor(Math.random() * 100),
                calibrated: true,
                timestamp: new Date().toISOString()
            };
            
            updateDashboard(simulatedData);
        }

        // Funci√≥n para recibir datos del ESP32
        function receiveDataFromESP32() {
            // Verificar si han llegado datos reales en los √∫ltimos 30 segundos
            if (lastDataReceived && (new Date() - lastDataReceived) < 30000) {
                return; // Datos reales recientes, no simular
            }
            
            // Si no hay datos reales, usar simulaci√≥n para pruebas
            simulateData();
        }

        // Funci√≥n para procesar datos reales del ESP32
        function processRealESP32Data(jsonData) {
            try {
                console.log('Procesando datos reales del ESP32:', jsonData);
                updateDashboard(jsonData);
                lastDataReceived = new Date();
                connectionStatus = true;
            } catch (error) {
                console.error('Error procesando datos reales del ESP32:', error);
            }
        }

        // Alternar tema
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const button = document.querySelector('.theme-toggle');
            button.textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
            
            // Guardar preferencia
            localStorage.setItem('kontrolgas_dark_theme', 
                document.body.classList.contains('dark-theme'));
        }

        // Cargar tema guardado
        function loadTheme() {
            const darkTheme = localStorage.getItem('kontrolgas_dark_theme') === 'true';
            if (darkTheme) {
                document.body.classList.add('dark-theme');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }

        // Event listeners
        document.getElementById('emptyWeight').addEventListener('input', function() {
            if (currentWeight > 0) {
                const newPercentage = calculateLiquidPercentage(currentWeight);
                updateGauge('liquidGauge', newPercentage);
                document.getElementById('liquidPercentage').textContent = newPercentage.toFixed(1) + '%';
            }
        });

        document.getElementById('fullWeight').addEventListener('input', function() {
            if (currentWeight > 0) {
                const newPercentage = calculateLiquidPercentage(currentWeight);
                updateGauge('liquidGauge', newPercentage);
                document.getElementById('liquidPercentage').textContent = newPercentage.toFixed(1) + '%';
            }
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('KontrolGas Dashboard inicializado');
            
            // Cargar configuraciones guardadas
            loadConfiguration();
            loadTheme();
            
            // Generar grid inicial
            generateChartGrid();
            
            // Iniciar recepci√≥n de datos
            receiveDataFromESP32();
            
            // Actualizar cada 5 segundos (para datos simulados)
            setInterval(receiveDataFromESP32, 5000);
            
            // Verificar conexi√≥n cada 30 segundos
            setInterval(function() {
                if (lastDataReceived && (new Date() - lastDataReceived) > 60000) {
                    // Sin datos por m√°s de 1 minuto
                    connectionStatus = false;
                    const indicator = document.getElementById('connectionIndicator');
                    const status_text = document.getElementById('connectionStatus');
                    indicator.classList.remove('connected');
                    status_text.textContent = 'Desconectado';
                }
            }, 30000);
        });

        // INTEGRACI√ìN CON ESP32 - Descomenta el m√©todo que prefieras:

        // M√©todo 1: HTTP Polling (el dashboard consulta al ESP32)
        /*
        setInterval(function() {
            fetch('http://IP-DE-TU-ESP32/data')
                .then(response => response.json())
                .then(data => processRealESP32Data(data))
                .catch(error => {
                    console.error('Error consultando ESP32:', error);
                    // Mantener simulaci√≥n si no hay conexi√≥n
                });
        }, 10000); // Consultar cada 10 segundos
        */

        // M√©todo 2: WebSocket (comunicaci√≥n bidireccional)
        /*
        const ws = new WebSocket('ws://IP-DE-TU-ESP32:81');
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            processRealESP32Data(data);
        };
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        */

        // M√©todo 3: Server-Sent Events (el ESP32 env√≠a eventos)
        /*
        const eventSource = new EventSource('http://IP-DE-TU-ESP32/events');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            processRealESP32Data(data);
        };
        */
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontrolGas Dashboard</title>
    
    <!-- Librer√≠a oficial de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    
    <style>
        /* ... (mantener todos los estilos que ten√≠as) ... */
    </style>
</head>
<body>
    <!-- ... (mantener toda la estructura HTML) ... -->

    <script>
        console.log('üìä KontrolGas Dashboard con Supabase cargado');

        // ============================================
        // CONFIGURACI√ìN DE SUPABASE
        // ============================================
        const SUPABASE_URL = "https://sxmqctvehtxqsdsjtftg.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4bXFjdHZlaHR4cXNkc2p0ZnRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDg3NzksImV4cCI6MjA4MjI4NDc3OX0.XTksCLbn7gNT3a-afVJJ7EfSFqfCc620Kit63IxfX9M";

        // Variables globales
        let supabaseClient = null;
        let isDarkTheme = false;
        let lastDataReceived = null;
        let currentDeviceId = 'KG_392a13d8'; // Device ID por defecto
        let dataPollingInterval = null;
        let isSupabaseConnected = false;

        // ============================================
        // INICIALIZACI√ìN DE SUPABASE (CORREGIDA)
        // ============================================
        function initSupabase() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üöÄ Inicializando cliente Supabase...');
                    
                    // Verificar que la librer√≠a est√© disponible
                    if (typeof supabase === 'undefined') {
                        throw new Error('Librer√≠a Supabase no disponible');
                    }
                    
                    // Crear cliente Supabase
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    console.log('‚úÖ Cliente Supabase creado correctamente');
                    resolve(true);
                } catch (error) {
                    console.error('‚ùå Error inicializando Supabase:', error);
                    reject(error);
                }
            });
        }

        // ============================================
        // CONEXI√ìN A SUPABASE CON RETRY
        // ============================================
        async function connectToSupabaseWithRetry(maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    await initSupabase();
                    isSupabaseConnected = true;
                    console.log('‚úÖ Conexi√≥n a Supabase establecida');
                    return true;
                } catch (error) {
                    console.log(`‚ö†Ô∏è Intento ${i + 1} fallido:`, error.message);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            console.log('‚ùå No se pudo conectar a Supabase despu√©s de', maxRetries, 'intentos');
            return false;
        }

        // ============================================
        // OBTENER DATOS DE SUPABASE
        // ============================================
        async function fetchLatestDataFromSupabase() {
            if (!supabaseClient || !isSupabaseConnected) {
                console.log('‚ö†Ô∏è No conectado a Supabase');
                return null;
            }

            try {
                console.log('üîÑ Buscando datos para device_id:', currentDeviceId);
                
                const { data, error } = await supabaseClient
                    .from('esp32_data')
                    .select('*')
                    .eq('device_id', currentDeviceId)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('‚ùå Error obteniendo datos:', error);
                    return null;
                }

                if (data && data.length > 0) {
                    console.log('‚úÖ Datos encontrados:', data[0]);
                    return data[0];
                } else {
                    console.log('‚ö†Ô∏è No se encontraron datos para', currentDeviceId);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error en fetch:', error);
                return null;
            }
        }

        // ============================================
        // INICIALIZACI√ìN DEL DASHBOARD
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Inicializando KontrolGas Dashboard...');
            
            // Cargar configuraci√≥n
            loadConfiguration();
            
            // Intentar conectar a Supabase
            const connected = await connectToSupabaseWithRetry();
            
            if (connected) {
                console.log('‚úÖ Dashboard inicializado CON conexi√≥n a Supabase');
                
                // Obtener datos iniciales
                const initialData = await fetchLatestDataFromSupabase();
                if (initialData) {
                    updateDashboard(initialData);
                }
                
                // Iniciar polling cada 30 segundos
                setInterval(async () => {
                    const data = await fetchLatestDataFromSupabase();
                    if (data) {
                        updateDashboard(data);
                    }
                }, 30000);
                
            } else {
                console.log('‚ùå Dashboard inicializado SIN conexi√≥n a Supabase');
                // Continuar con simulaci√≥n
                setInterval(simulateData, 5000);
                simulateData();
            }
            
            // Configurar eventos
            document.getElementById('emptyWeight').addEventListener('input', updateYAxisAndGrid);
            document.getElementById('fullWeight').addEventListener('input', updateYAxisAndGrid);
            setInterval(checkConnectionStatus, 30000);
            
            console.log('‚úÖ Dashboard KontrolGas inicializado correctamente');
        });

        // ============================================
        // FUNCIONES EXISTENTES (MANTENER LAS QUE TEN√çAS)
        // ============================================
        function updateDashboard(data) {
            console.log('üìä Actualizando dashboard con datos:', data);
            
            // Actualizar peso digital
            if (data.weight !== undefined) {
                const weight = parseFloat(data.weight);
                document.getElementById('digitalWeight').textContent = weight.toFixed(2);
                
                // Calcular nivel de l√≠quido
                const emptyWeight = parseFloat(document.getElementById('emptyWeight').value) || 5;
                const fullWeight = parseFloat(document.getElementById('fullWeight').value) || 13;
                
                if (fullWeight > emptyWeight) {
                    const percentage = Math.max(0, Math.min(100, ((weight - emptyWeight) / (fullWeight - emptyWeight)) * 100));
                    document.getElementById('liquidLevel').textContent = percentage.toFixed(1) + '%';
                    updateGauge(percentage);
                }
            }
            
            // Actualizar medidor de bater√≠a
            updateBatteryMeter(data);
            lastDataReceived = Date.now();
        }

        // ... (mantener todas tus otras funciones como updateGauge, updateBatteryMeter, etc.)

        function simulateData() {
            if (isSupabaseConnected) return; // No simular si est√° conectado
            
            const testData = {
                device_id: 'SIMULACION',
                firmware_version: 'v80.32-TEST',
                weight: (Math.random() * 8 + 5).toFixed(2),
                raw_value: Math.floor(Math.random() * 100000),
                calibrated: true,
                tara_set: true,
                battery_percentage: Math.floor(Math.random() * 100),
                battery_voltage: (3.0 + Math.random() * 1.2).toFixed(2),
                battery_icon: Math.random() > 0.7 ? 'üü°' : 'üü¢',
                battery_is_low: Math.random() > 0.8,
                battery_is_critical: Math.random() > 0.95,
                battery_hours_remaining: Math.floor(Math.random() * 24),
                battery_capacity_mah: 3000,
                wifi_connected: true,
                wifi_ssid: 'TestNetwork'
            };
            
            updateDashboard(testData);
        }

        // ... (mantener el resto de tus funciones)
    </script>
</body>
</html>

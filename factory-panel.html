<script>
        const SUPABASE_URL = 'https://sxmqctvehtxqsdsjtftg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4bXFjdHZlaHR4cXNkc2p0ZnRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDg3NzksImV4cCI6MjA4MjI4NDc3OX0.XTksCLbn7gNT3a-afVJJ7EfSFqfCc620Kit63IxfX9M';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const alertContainer = document.getElementById('alertContainer');
        const clientesContainer = document.getElementById('clientesContainer');

        // Generar c√≥digo aleatorio
        function generateCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = 'CLI';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('codigoCliente').value = code;
        }

        // Mostrar alerta
        function showAlert(message, type = 'success') {
            alertContainer.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'} show">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 4000);
        }

        // Validar direcci√≥n MAC
        function validarMAC(mac) {
            const regex = /^([0-9A-Fa-f]{2}:){5}([0-9A-Fa-f]{2})$/;
            return regex.test(mac);
        }

        // Registrar cliente en Supabase
        async function registerClient(event) {
            event.preventDefault();

            const codigo = document.getElementById('codigoCliente').value.trim().toUpperCase();
            const mac = document.getElementById('macEsp32').value.trim().toUpperCase();
            const nombre = document.getElementById('nombreCliente').value.trim();

            if (!/^CLI[A-Z0-9]{8}$/.test(codigo)) {
                showAlert('‚ùå C√≥digo de cliente inv√°lido. Debe ser CLI seguido de 8 caracteres alfanum√©ricos.', 'error');
                return;
            }

            if (!validarMAC(mac)) {
                showAlert('‚ùå MAC ESP32 inv√°lida. Debe tener el formato AA:BB:CC:DD:EE:FF.', 'error');
                return;
            }

            // Verificar si ya existe c√≥digo
            const { data: existingCode } = await supabase
                .from('clientes')
                .select('id')
                .eq('codigo_cliente', codigo)
                .maybeSingle();

            if (existingCode) {
                showAlert('‚ùå El c√≥digo de cliente ya existe.', 'error');
                return;
            }

            // Verificar si ya existe MAC
            const { data: existingMac } = await supabase
                .from('clientes')
                .select('id')
                .eq('mac_esp32', mac)
                .maybeSingle();

            if (existingMac) {
                showAlert('‚ùå La MAC ESP32 ya est√° registrada.', 'error');
                return;
            }

            // Insertar cliente
            const { error } = await supabase
                .from('clientes')
                .insert([
                    { 
                        codigo_cliente: codigo, 
                        mac_esp32: mac, 
                        nombre: nombre || null, 
                        estado: 'activo' 
                    }
                ]);

            if (error) {
                console.error('Error completo:', error);
                showAlert('‚ùå Error registrando cliente: ' + error.message, 'error');
            } else {
                showAlert('‚úÖ Cliente registrado con √©xito.');
                document.getElementById('registerForm').reset();
                cargarClientes();
            }
        }

        // Cargar lista de clientes
        async function cargarClientes() {
            console.log('üîÑ Cargando clientes...');
            clientesContainer.innerHTML = '<div class="loading">Cargando...</div>';

            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('Datos recibidos:', data);
                console.log('Error:', error);

                if (error) {
                    console.error('Error completo:', error);
                    clientesContainer.innerHTML = `<div class="alert alert-error show">‚ùå Error cargando clientes: ${error.message}</div>`;
                    return;
                }

                if (!data || data.length === 0) {
                    clientesContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No hay clientes registrados.</p>';
                    return;
                }

                // Tabla HTML
                let html = `<div class="table-container"><table>
                    <thead>
                        <tr>
                            <th>C√≥digo Cliente</th>
                            <th>MAC ESP32</th>
                            <th>Nombre</th>
                            <th>Estado</th>
                        </tr>
                    </thead><tbody>`;

                data.forEach(cliente => {
                    html += `<tr>
                        <td><strong>${cliente.codigo_cliente}</strong></td>
                        <td><code>${cliente.mac_esp32}</code></td>
                        <td>${cliente.nombre || '-'}</td>
                        <td><span class="badge ${cliente.estado === 'activo' ? 'badge-active' : 'badge-inactive'}">${cliente.estado}</span></td>
                    </tr>`;
                });

                html += '</tbody></table></div>';

                clientesContainer.innerHTML = html;
                console.log('‚úÖ Clientes cargados correctamente');

            } catch (e) {
                console.error('Excepci√≥n:', e);
                clientesContainer.innerHTML = `<div class="alert alert-error show">‚ùå Error inesperado: ${e.message}</div>`;
            }
        }

        // Inicializar
        window.addEventListener('load', () => {
            console.log('üöÄ Iniciando panel de f√°brica...');
            cargarClientes();
        });
    </script>
</body>
</html>

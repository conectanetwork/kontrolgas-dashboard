html 
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KontrolGas - Dashboard Profesional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* DASHBOARD (hidden until login) */
        .dashboard-container {
            display: none;
        }

        .dashboard-container.show {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .theme-toggle {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        .status-bar {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        .status-indicator.disconnected {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .status-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gauge-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            aspect-ratio: 2 / 1;
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
        }

        .gauge-background {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 12;
        }

        .gauge-progress {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease;
        }

        .gauge-text {
            text-anchor: middle;
            font-size: 48px;
            font-weight: 100;
            fill: var(--text-primary);
        }

        .gauge-label {
            text-anchor: middle;
            font-size: 14px;
            fill: var(--text-secondary);
        }

        .digital-display {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
        }

        .digital-value {
            font-size: 64px;
            font-weight: 200;
            color: white;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
        }

        .digital-label {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 10px;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .config-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-input {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 36px;
            }
            
            .digital-value {
                font-size: 48px;
            }

            .theme-toggle, .logout-btn {
                position: static;
                margin: 10px auto;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <svg class="login-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#logoGradient)" opacity="0.2"/>
                <path d="M 50 20 L 50 50 L 70 70" stroke="url(#logoGradient)" stroke-width="6" fill="none" stroke-linecap="round"/>
                <circle cx="50" cy="50" r="8" fill="url(#logoGradient)"/>
                <text x="50" y="90" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="url(#logoGradient)" text-anchor="middle">K</text>
            </svg>

            <h1 class="login-title">KontrolGas</h1>
            <p class="login-subtitle">Ingrese su c√≥digo de cliente</p>

            <form id="loginForm">
                <input 
                    type="text" 
                    id="codigoInput" 
                    class="login-input" 
                    placeholder="CLI12AB34CD"
                    pattern="CLI[A-Z0-9]{8}"
                    maxlength="11"
                    required
                    autocomplete="off"
                >
                <button type="submit" class="login-btn">
                    üîê Acceder al Dashboard
                </button>
            </form>

            <div id="loginError" class="login-error"></div>
        </div>
    </div>

    <!-- DASHBOARD (hidden until login) -->
    <div id="dashboardScreen" class="dashboard-container">
        <div class="container">
            <div class="header">
                <button class="logout-btn" onclick="logout()">
                    üö™ Cerrar Sesi√≥n
                </button>

                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Tema Oscuro</span>
                </button>

                <div class="logo-container">
                    <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="45" fill="url(#logoGradient2)" opacity="0.2"/>
                        <path d="M 50 20 L 50 50 L 70 70" stroke="url(#logoGradient2)" stroke-width="6" fill="none" stroke-linecap="round"/>
                        <circle cx="50" cy="50" r="8" fill="url(#logoGradient2)"/>
                        <text x="50" y="90" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="url(#logoGradient2)" text-anchor="middle">K</text>
                    </svg>
                </div>

                <h1>KontrolGas</h1>
                <p>Monitoreo de Gas Profesional</p>
                <div class="badge">üöÄ Nivel 2: Env√≠o Condicional | 97% Ahorro</div>
            </div>
            <!-- Barra de Estado -->
            <div class="status-bar">
                <div class="status-item">
                    <div id="mqttIndicator" class="status-indicator disconnected"></div>
                    <div>
                        <div class="status-text">Estado MQTT</div>
                        <div class="status-value" id="mqttStatus">Conectando...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div>
                        <div class="status-text">Cliente:</div>
                        <div class="status-value" id="clienteCode">-</div>
                    </div>
                </div>
                <div class="status-item">
                    <div>
                        <div class="status-text">√öltima Actualizaci√≥n:</div>
                        <div class="status-value" id="lastUpdate">-</div>
                    </div>
                </div>
                <div class="status-item">
                    <div>
                        <div class="status-text">RSSI WiFi:</div>
                        <div class="status-value" id="rssiValue">- dBm</div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Principal -->
            <div class="dashboard">
                <!-- Gauge Semicircular -->
                <div class="card">
                    <div class="card-title">
                        üìä Nivel de L√≠quido
                    </div>
                    <div class="gauge-container">
                        <svg class="gauge-svg" viewBox="0 0 200 110">
                            <path class="gauge-background" 
                                  d="M 20 100 A 80 80 0 0 1 180 100" 
                                  stroke-dasharray="251.2" 
                                  stroke-dashoffset="0"/>
                            <path id="gaugeProgress" 
                                  class="gauge-progress" 
                                  d="M 20 100 A 80 80 0 0 1 180 100" 
                                  stroke="#3b82f6"
                                  stroke-dasharray="251.2" 
                                  stroke-dashoffset="251.2"/>
                            <text id="gaugePercentage" class="gauge-text" x="100" y="85">0.0%</text>
                            <text class="gauge-label" x="100" y="105">Disponible</text>
                        </svg>
                    </div>
                </div>

                <!-- Display Digital -->
                <div class="card">
                    <div class="card-title">
                        üî¢ Peso Digital
                    </div>
                    <div class="digital-display">
                        <div id="digitalWeight" class="digital-value">0.00</div>
                        <div class="digital-label">kg</div>
                    </div>
                </div>

                <!-- Gr√°fico de Consumo -->
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="card-title">
                        üìà Consumo √öltimas 24 Horas
                    </div>
                    <div class="chart-container">
                        <canvas id="consumptionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n -->
            <div class="config-section">
                <div class="card-title">
                    ‚öôÔ∏è Configuraci√≥n de Pesos
                </div>
                <div class="config-grid">
                    <div class="config-item">
                        <label class="config-label">Peso Vac√≠o (kg)</label>
                        <input type="number" id="emptyWeight" class="config-input" step="0.01" value="0">
                    </div>
                    <div class="config-item">
                        <label class="config-label">Peso Lleno (kg)</label>
                        <input type="number" id="fullWeight" class="config-input" step="0.01" value="15">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveConfiguration()">
                        üíæ Guardar Configuraci√≥n
                    </button>
                    <button class="btn btn-secondary" onclick="resetConfiguration()">
                        üîÑ Restablecer
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://sxmqctvehtxqsdsjtftg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4bXFjdHZlaHR4cXNkc2p0ZnRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDg3NzksImV4cCI6MjA4MjI4NDc3OX0.XTksCLbn7gNT3a-afVJJ7EfSFqfCc620Kit63IxfX9M';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // CONFIGURACI√ìN MQTT
        // ============================================
        const MQTT_BROKER = 'wss://test.mosquitto.org:8081';
        const MQTT_TOPIC = 'kontrol-gas/esp32/weight';
        
        let mqttClient = null;
        let currentWeight = 0;
        let emptyWeight = 0;
        let fullWeight = 15;
        let consumptionChart = null;
        let userMac = null;
        let userCode = null;

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        async function checkLogin() {
            const savedCode = localStorage.getItem('kontrolgas_code');
            const savedMac = localStorage.getItem('kontrolgas_mac');

            if (savedCode && savedMac) {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('codigo_cliente', savedCode)
                    .eq('estado', 'activo')
                    .single();

                if (data && !error) {
                    userCode = savedCode;
                    userMac = savedMac;
                    await loadHistoricalData();
                    showDashboard();
                    return;
                }
            }

            showLogin();
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').classList.remove('show');
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').classList.add('show');
            document.getElementById('clienteCode').textContent = userCode;
            
            loadTheme();
            loadConfiguration();
            connectMQTT();
            updateDisplay();
        }

        // EVENTO LOGIN FORM
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const codigo = document.getElementById('codigoInput').value.toUpperCase();
            const errorDiv = document.getElementById('loginError');

            if (!/^CLI[A-Z0-9]{8}$/.test(codigo)) {
                errorDiv.textContent = '‚ùå Formato inv√°lido. Use: CLI + 8 caracteres alfanum√©ricos';
                errorDiv.classList.add('show');
                return;
            }

            const { data, error } = await supabase
                .from('clientes')
                .select('*')
                .eq('codigo_cliente', codigo)
                .single();

            if (error || !data) {
                errorDiv.textContent = '‚ùå C√≥digo de cliente no encontrado';
                errorDiv.classList.add('show');
                return;
            }

            if (data.estado !== 'activo') {
                errorDiv.textContent = '‚ùå Este c√≥digo ha sido desactivado. Contacte a soporte.';
                errorDiv.classList.add('show');
                return;
            }

            userCode = data.codigo_cliente;
            userMac = data.mac_esp32;

            localStorage.setItem('kontrolgas_code', userCode);
            localStorage.setItem('kontrolgas_mac', userMac);

            await loadHistoricalData();

            showDashboard();
        });

        function logout() {
            localStorage.removeItem('kontrolgas_code');
            localStorage.removeItem('kontrolgas_mac');
            userCode = null;
            userMac = null;
            if (mqttClient) {
                mqttClient.end();
            }
            showLogin();
        }

        // ============================================
        // TEMA DARK/LIGHT
        // ============================================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('themeText').textContent = newTheme === 'light' ? 'Tema Claro' : 'Tema Oscuro';
            if (consumptionChart) {
                updateChartTheme();
            }
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            document.getElementById('themeText').textContent = savedTheme === 'light' ? 'Tema Claro' : 'Tema Oscuro';
        }

        // ============================================
        // CARGAR Y GUARDAR CONFIGURACION PESOS
        // ============================================
        function loadConfiguration() {
            const savedEmpty = localStorage.getItem('emptyWeight_' + userMac);
            const savedFull = localStorage.getItem('fullWeight_' + userMac);
            if (savedEmpty) {
                emptyWeight = parseFloat(savedEmpty);
                document.getElementById('emptyWeight').value = emptyWeight;
            }
            if (savedFull) {
                fullWeight = parseFloat(savedFull);
                document.getElementById('fullWeight').value = fullWeight;
            }
        }
        function saveConfiguration() {
            emptyWeight = parseFloat(document.getElementById('emptyWeight').value);
            fullWeight = parseFloat(document.getElementById('fullWeight').value);
            localStorage.setItem('emptyWeight_' + userMac, emptyWeight);
            localStorage.setItem('fullWeight_' + userMac, fullWeight);
            updateDisplay();
            alert('‚úÖ Configuraci√≥n guardada correctamente');
        }
        function resetConfiguration() {
            document.getElementById('emptyWeight').value = 0;
            document.getElementById('fullWeight').value = 15;
            emptyWeight = 0;
            fullWeight = 15;
            localStorage.setItem('emptyWeight_' + userMac, 0);
            localStorage.setItem('fullWeight_' + userMac, 15);
            updateDisplay();
            alert('üîÑ Configuraci√≥n restablecida');
        }
        if (!consumptionChart) return;

            consumptionChart.options.scales.x.ticks.color = textColor;
            consumptionChart.options.scales.x.grid.color = gridColor;
            consumptionChart.options.scales.y.ticks.color = textColor;
            consumptionChart.options.scales.y.grid.color = gridColor;
            consumptionChart.update();
        }

        // ============================================
        // INICIALIZACI√ìN AL CARGAR P√ÅGINA
        // ============================================
        window.addEventListener('load', () => {
            checkLogin();
        });
    </script>
</body>
</html>

